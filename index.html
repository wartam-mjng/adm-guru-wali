<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guru Wali Pro - Administrasi Terpadu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .nav-btn { transition: all 0.2s ease; border-radius: 12px; margin-bottom: 4px; color: #cbd5e1; }
        .nav-btn:hover { background-color: #334155; color: white; }
        .nav-btn.active { background-color: #2563eb !important; color: white !important; }

        #sidebar { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); width: 20rem; min-width: 20rem; }
        #sidebar.collapsed { width: 0; min-width: 0; transform: translateX(-100%); opacity: 0; pointer-events: none; }
        
        main { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        @media print {
            .no-print { display: none !important; }
            body { background: white !important; }
            .tab-content.active { display: block !important; padding: 0 !important; }
            .shadow-sm { box-shadow: none !important; border: 1px solid #e2e8f0 !important; }
            main { overflow: visible !important; height: auto !important; }
            #sidebar { display: none !important; }
        }

        .edit-input { width: 100%; border: none; background: transparent; outline: none; resize: none; padding: 4px; display: block; }
        .edit-input:focus { background-color: #f8fafc; border-radius: 4px; box-shadow: inset 0 0 0 1px #e2e8f0; }
        
        .fab-container { position: fixed; bottom: 2rem; right: 2rem; display: flex; flex-direction: column; gap: 0.75rem; z-index: 100; }
        .fab { width: 3.5rem; height: 3.5rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; color: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.2); transition: all 0.2s ease; border: 2px solid rgba(255,255,255,0.1); cursor: pointer; }
        .fab:hover { transform: scale(1.1); filter: brightness(1.1); }
        .fab:active { transform: scale(0.95); }
        
        table th, table td { border: 1px solid #cbd5e1; }
        .table-responsive { overflow-x: auto; }

        .form-section-title { @apply text-sm font-black uppercase tracking-widest text-blue-600 mb-4 border-b pb-2; }
        .input-group { @apply flex flex-col md:flex-row md:items-center gap-2 mb-4; }
        .input-label { @apply w-full md:w-64 text-sm font-medium text-slate-700; }
        .form-control { @apply flex-1 p-2.5 border border-slate-300 rounded-lg outline-none focus:border-blue-500 transition text-sm; }
    </style>
</head>
<body class="bg-[#1e293b] text-slate-200 overflow-hidden text-sm">

    <div class="flex h-screen w-full overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="bg-[#1e293b] text-white flex-shrink-0 flex flex-col z-30 no-print border-r border-slate-700/50">
            <div class="p-8 text-center border-b border-slate-700/50 flex flex-col items-center">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mb-4 shadow-lg shadow-blue-900/20">
                    <i data-lucide="graduation-cap" class="w-10 h-10 text-white"></i>
                </div>
                <h1 class="font-black text-xl tracking-tighter leading-tight uppercase whitespace-nowrap">GURU WALI PRO</h1>
                <p class="text-[10px] text-slate-400 tracking-[0.2em] mt-1">ADMINISTRATION SYSTEM</p>
            </div>
            
            <nav class="flex-1 px-4 py-6 space-y-1 overflow-y-auto">
                <button onclick="showTab('identitas')" class="nav-btn w-full flex items-center gap-4 p-4 text-left active">
                    <i data-lucide="id-card" class="w-5 h-5"></i>
                    <span class="font-semibold text-base whitespace-nowrap">Isi Identitas</span>
                </button>
                <button onclick="showTab('program-kerja')" class="nav-btn w-full flex items-center gap-4 p-4 text-left">
                    <i data-lucide="clipboard-list" class="w-5 h-5"></i>
                    <span class="font-semibold text-base whitespace-nowrap">Program Kerja</span>
                </button>
                <button onclick="showTab('data-murid')" class="nav-btn w-full flex items-center gap-4 p-4 text-left">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="font-semibold text-base whitespace-nowrap">Data Murid</span>
                </button>
                <button onclick="showTab('profil-murid')" class="nav-btn w-full flex items-center gap-4 p-4 text-left">
                    <i data-lucide="user-square-2" class="w-5 h-5"></i>
                    <span class="font-semibold text-base whitespace-nowrap">Profil Murid</span>
                </button>
                <button onclick="showTab('jurnal')" class="nav-btn w-full flex items-center gap-4 p-4 text-left">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                    <span class="font-semibold text-base whitespace-nowrap">Jurnal Pertemuan</span>
                </button>
                <button onclick="showTab('laporan')" class="nav-btn w-full flex items-center gap-4 p-4 text-left">
                    <i data-lucide="file-bar-chart-2" class="w-5 h-5"></i>
                    <span class="font-semibold text-base whitespace-nowrap">Laporan Perkembangan</span>
                </button>
                <button onclick="showTab('pengembangan-diri')" class="nav-btn w-full flex items-center gap-4 p-4 text-left">
                    <i data-lucide="trending-up" class="w-5 h-5"></i>
                    <span class="font-semibold text-base whitespace-nowrap">Pengembangan Diri</span>
                </button>
            </nav>

            <div class="p-4 bg-slate-900/30">
                <button onclick="showTab('settings')" class="w-full flex items-center justify-center gap-2 text-slate-500 hover:text-white text-[10px] uppercase tracking-widest py-3 transition border border-slate-700/50 rounded-xl">
                    <i data-lucide="settings" class="w-3 h-3"></i>
                    Konfigurasi Cloud
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col min-w-0 overflow-hidden bg-slate-100 text-slate-900 relative">
            <header class="h-16 border-b border-slate-200 bg-white flex items-center px-4 no-print flex-shrink-0 shadow-sm z-20">
                <button onclick="toggleSidebar()" class="p-2 hover:bg-slate-100 rounded-lg text-slate-600 transition-all border border-slate-200 flex items-center justify-center">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
                <div class="ml-4 font-bold text-slate-500 uppercase tracking-widest text-[10px] hidden sm:block">
                    Dashboard Administrasi Guru Wali
                </div>
            </header>

            <div class="fab-container no-print">
                <button onclick="syncToCloud()" class="fab bg-purple-600" title="Simpan ke Cloud">
                    <i data-lucide="save" class="w-6 h-6"></i>
                </button>
                <button onclick="downloadBackup()" class="fab bg-emerald-500" title="Unduh Cadangan">
                    <i data-lucide="download" class="w-6 h-6"></i>
                </button>
                <button onclick="window.print()" class="fab bg-blue-600" title="Cetak Laporan">
                    <i data-lucide="printer" class="w-6 h-6"></i>
                </button>
            </div>

            <div class="flex-1 overflow-y-auto p-4 md:p-8 scroll-smooth" id="contentScroll">
                
                <!-- 1. Isi Identitas -->
                <section id="identitas" class="tab-content active max-w-5xl mx-auto">
                    <div class="bg-white rounded-lg shadow-sm border border-slate-200 p-8 md:p-16 min-h-[600px]">
                        <div class="text-center mb-12">
                            <h2 class="text-3xl font-bold text-slate-800 uppercase tracking-tight">IDENTITAS GURU WALI</h2>
                        </div>
                        <div class="space-y-6 max-w-4xl">
                            <div class="flex flex-col md:flex-row md:items-center gap-4">
                                <label class="w-full md:w-64 text-base font-medium text-slate-700">Nama Lengkap</label>
                                <input type="text" id="namaGuru" class="flex-1 p-3 border border-slate-300 rounded-md outline-none focus:border-blue-500 transition" oninput="saveData('guru_name', this.value)">
                            </div>
                            <div class="flex flex-col md:flex-row md:items-center gap-4">
                                <label class="w-full md:w-64 text-base font-medium text-slate-700">NIP</label>
                                <input type="text" id="nipGuru" class="flex-1 p-3 border border-slate-300 rounded-md outline-none focus:border-blue-500 transition" oninput="saveData('guru_nip', this.value)">
                            </div>
                            <div class="flex flex-col md:flex-row md:items-center gap-4">
                                <label class="w-full md:w-64 text-base font-medium text-slate-700">Wali Kelas</label>
                                <input type="text" id="kelasGuru" class="flex-1 p-3 border border-slate-300 rounded-md outline-none focus:border-blue-500 transition" oninput="saveData('guru_kelas', this.value)">
                            </div>
                            <div class="flex flex-col md:flex-row md:items-center gap-4">
                                <label class="w-full md:w-64 text-base font-medium text-slate-700">Tahun Pelajaran</label>
                                <div class="flex-1 flex flex-col gap-2">
                                    <select id="tahunPelajaranSelect" class="p-3 border border-slate-300 rounded-md outline-none focus:border-blue-500 transition bg-white" onchange="handleTahunPelajaran(this.value)">
                                        <option value="">-- Pilih Tahun --</option>
                                        <option value="2025/2026">2025/2026</option>
                                        <option value="Lainnya">Lainnya</option>
                                    </select>
                                    <input type="text" id="tahunPelajaranManual" class="p-3 border border-slate-300 rounded-md outline-none focus:border-blue-500 transition hidden" placeholder="Masukkan Tahun Pelajaran Manual" oninput="saveData('guru_tahun_pelajaran_manual', this.value)">
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. Program Kerja (Statis / Edit Langsung) -->
                <section id="program-kerja" class="tab-content max-w-5xl mx-auto">
                    <div class="bg-white rounded-lg border border-slate-200 p-8 md:p-12 shadow-sm min-h-[1000px]">
                        <h3 class="text-3xl font-bold mb-8 text-center uppercase tracking-tight">PROGRAM KERJA</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-[12px] leading-relaxed">
                                <thead class="bg-slate-50 text-slate-600 font-bold">
                                    <tr>
                                        <th class="p-3 w-12 text-center">No.</th>
                                        <th class="p-3 w-1/4 text-left">Pilar Program</th>
                                        <th class="p-3 w-1/3 text-left">Bentuk Kegiatan</th>
                                        <th class="p-3 text-left">Indikator Keberhasilan</th>
                                    </tr>
                                </thead>
                                <tbody id="progTable" class="text-slate-700"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 3. Data Murid -->
                <section id="data-murid" class="tab-content max-w-6xl mx-auto">
                    <div class="bg-white rounded-lg border border-slate-200 p-6 md:p-10 shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 no-print">
                            <div>
                                <h3 class="text-2xl font-black uppercase tracking-tight">DATA MURID</h3>
                                <p class="text-slate-500 text-xs uppercase tracking-widest mt-1">Kelola daftar murid perwalian</p>
                            </div>
                            <button onclick="addStudentRow()" class="bg-blue-600 text-white px-6 py-3 rounded-xl text-xs font-bold hover:bg-blue-700 transition flex items-center gap-2 shadow-lg shadow-blue-200">
                                <i data-lucide="user-plus" class="w-4 h-4"></i> TAMBAH MURID
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="w-full border-collapse border border-slate-200 min-w-[900px]">
                                <thead class="bg-slate-50 text-slate-600">
                                    <tr>
                                        <th class="border p-3 w-12 text-[10px] font-black uppercase">No</th>
                                        <th class="border p-3 text-left text-[10px] font-black uppercase">Nama Lengkap</th>
                                        <th class="border p-3 text-left text-[10px] font-black uppercase w-32">NIS</th>
                                        <th class="border p-3 text-left text-[10px] font-black uppercase w-32">NISN</th>
                                        <th class="border p-3 text-left text-[10px] font-black uppercase w-28">L/P</th>
                                        <th class="border p-3 text-left text-[10px] font-black uppercase w-24">Kelas</th>
                                        <th class="border p-3 text-left text-[10px] font-black uppercase w-28">Thn Masuk</th>
                                        <th class="border p-3 w-12 no-print bg-slate-100"></th>
                                    </tr>
                                </thead>
                                <tbody id="studentTable"></tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- 4. Profil Murid (Pembaruan Berdasarkan Lampiran) -->
                <section id="profil-murid" class="tab-content max-w-5xl mx-auto">
                    <div class="bg-white rounded-lg border border-slate-200 p-8 md:p-12 shadow-sm min-h-screen">
                        <h3 class="text-3xl font-bold mb-10 text-center uppercase tracking-tight">PROFIL MURID</h3>
                        
                        <!-- Header Profil -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4 mb-10 pb-8 border-b">
                            <div class="input-group">
                                <label class="input-label">Nama Lengkap Murid</label>
                                <select id="profilNamaSelect" class="form-control font-bold" onchange="loadStudentProfile(this.value)">
                                    <option value="">-- Pilih Murid --</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label class="input-label">NIS / NISN</label>
                                <input type="text" id="profilNis" class="form-control bg-slate-50" readonly placeholder="-">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Kelas</label>
                                <input type="text" id="profilKelas" class="form-control bg-slate-50" readonly placeholder="-">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Nama Guru Wali</label>
                                <input type="text" id="profilGuruWali" class="form-control bg-slate-50" readonly placeholder="-">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Tahun Masuk</label>
                                <input type="text" id="profilTahunMasuk" class="form-control bg-slate-50" readonly placeholder="-">
                            </div>
                        </div>

                        <!-- Bagian A: Data Diri & Keluarga -->
                        <div class="mb-10">
                            <h4 class="form-section-title">A. DATA DIRI & KELUARGA</h4>
                            <div class="input-group">
                                <label class="input-label">Alamat</label>
                                <textarea id="prof_alamat" class="form-control" rows="3" oninput="saveProfileData('alamat', this.value)"></textarea>
                            </div>
                            <div class="input-group">
                                <label class="input-label">No. Telepon (Murid / Orang Tua)</label>
                                <input type="text" id="prof_telp" class="form-control" oninput="saveProfileData('telp', this.value)">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Nama Orang Tua / Wali</label>
                                <input type="text" id="prof_ortu" class="form-control" oninput="saveProfileData('ortu', this.value)">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Pekerjaan Orang Tua / Wali</label>
                                <input type="text" id="prof_pekerjaan" class="form-control" oninput="saveProfileData('pekerjaan', this.value)">
                            </div>
                        </div>

                        <!-- Bagian B: Riwayat Akademik -->
                        <div class="mb-10">
                            <h4 class="form-section-title">B. RIWAYAT AKADEMIK</h4>
                            <div class="input-group">
                                <label class="input-label">Rata-rata Nilai Rapor Kelas Sebelumnya</label>
                                <input type="text" id="prof_rapor" class="form-control" oninput="saveProfileData('rapor', this.value)">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Mata Pelajaran yang Paling Disukai</label>
                                <input type="text" id="prof_mapel_suka" class="form-control" oninput="saveProfileData('mapel_suka', this.value)">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Mata Pelajaran yang Dianggap Sulit</label>
                                <input type="text" id="prof_mapel_sulit" class="form-control" oninput="saveProfileData('mapel_sulit', this.value)">
                            </div>
                        </div>

                        <!-- Bagian C: Minat, Bakat & Prestasi -->
                        <div class="mb-10">
                            <h4 class="form-section-title">C. MINAT, BAKAT, & PRESTASI NON-AKADEMIK</h4>
                            <div class="input-group">
                                <label class="input-label">Hobi / Minat</label>
                                <input type="text" id="prof_hobi" class="form-control" oninput="saveProfileData('hobi', this.value)">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Ekstrakurikuler yang Diikuti</label>
                                <input type="text" id="prof_ekskul" class="form-control" oninput="saveProfileData('ekskul', this.value)">
                            </div>
                            <div class="input-group">
                                <label class="input-label">Prestasi yang Pernah Diraih</label>
                                <input type="text" id="prof_prestasi" class="form-control" oninput="saveProfileData('prestasi', this.value)">
                            </div>
                        </div>

                        <!-- Bagian D: Target & Harapan Awal -->
                        <div class="mb-10">
                            <h4 class="form-section-title">D. TARGET & HARAPAN AWAL</h4>
                            <div class="input-group">
                                <label class="input-label">Apa yang ingin kamu capai di tahun ini (akademik / non-akademik)?</label>
                                <textarea id="prof_target" class="form-control" rows="3" oninput="saveProfileData('target', this.value)"></textarea>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Apa dukungan yang kamu harapkan dari Guru Wali?</label>
                                <textarea id="prof_dukungan" class="form-control" rows="3" oninput="saveProfileData('dukungan', this.value)"></textarea>
                            </div>
                            <div class="input-group">
                                <label class="input-label">Catatan Awal Guru Wali</label>
                                <textarea id="prof_catatan" class="form-control" rows="3" oninput="saveProfileData('catatan', this.value)"></textarea>
                            </div>
                        </div>

                        <div class="text-right mt-12 italic text-slate-400 no-print">
                            Data disimpan secara lokal di browser Anda.
                        </div>
                    </div>
                </section>

                <section id="jurnal" class="tab-content max-w-5xl mx-auto"><div class="p-10 bg-white rounded-lg shadow-sm border">Jurnal Pertemuan Content</div></section>
                <section id="laporan" class="tab-content max-w-5xl mx-auto"><div class="p-10 bg-white rounded-lg shadow-sm border">Laporan Perkembangan Content</div></section>
                <section id="pengembangan-diri" class="tab-content max-w-5xl mx-auto"><div class="p-10 bg-white rounded-lg shadow-sm border">Pengembangan Diri Content</div></section>

                <section id="settings" class="tab-content max-w-3xl mx-auto">
                    <div class="bg-white rounded-lg border border-slate-200 p-10 shadow-sm">
                        <h3 class="text-xl font-bold mb-6 text-center uppercase">Konfigurasi Endpoint</h3>
                        <div class="space-y-4">
                            <label class="text-xs font-bold uppercase text-slate-400 block">URL Google Apps Script</label>
                            <input type="text" id="apiUrl" class="w-full p-3 bg-slate-50 border border-slate-300 rounded font-mono text-xs" placeholder="https://script.google.com/macros/s/..." oninput="saveData('api_url', this.value)">
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script>
        const PRE = "gw_pro_v6_";
        
        function refreshIcons() { if (typeof lucide !== 'undefined') { lucide.createIcons(); } }
        function saveData(key, val) { localStorage.setItem(PRE + key, val); }
        function loadData(key) { return localStorage.getItem(PRE + key); }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            setTimeout(refreshIcons, 400);
        }

        function handleTahunPelajaran(val) {
            saveData('guru_tahun_pelajaran_select', val);
            const manualInput = document.getElementById('tahunPelajaranManual');
            if (val === 'Lainnya') { manualInput.classList.remove('hidden'); } 
            else { manualInput.classList.add('hidden'); }
        }

        function showTab(id) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            
            const btn = Array.from(document.querySelectorAll('.nav-btn')).find(b => b.getAttribute('onclick').includes(`'${id}'`));
            if(btn) btn.classList.add('active');
            
            document.getElementById('contentScroll').scrollTop = 0;
            if(id === 'profil-murid') updateStudentDropdown();
            refreshIcons();
            autoResizeTextareas();
        }

        // Program Kerja Logic
        const defaultProg = [
            { p: "Pendampingan Akademik", k: "1. Melakukan pemetaan awal...\n2. Diskusi rutin bulanan...", i: "Murid mengetahui kekuatan..." },
            { p: "Pengembangan Kompetensi", k: "1. Identifikasi bakat...\n2. Rekomendasi ekskul...", i: "Murid aktif kegiatan..." },
            { p: "Pengembangan Keterampilan", k: "1. Proyek kepemimpinan...\n2. Diskusi soft skills...", i: "Peningkatan komunikasi..." },
            { p: "Pengembangan Karakter", k: "1. Observasi perilaku...\n2. Konseling nilai...", i: "Disiplin & Tanggung jawab..." }
        ];
        let progData = JSON.parse(loadData('prog_pilar')) || defaultProg;

        function renderProg() {
            const tbody = document.getElementById('progTable');
            if(!tbody) return;
            tbody.innerHTML = '';
            progData.forEach((it, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 text-center font-bold border border-slate-300 bg-slate-50">${i+1}</td>
                    <td class="p-3 border border-slate-300 font-bold"><textarea class="edit-input font-bold" oninput="updProg(${i}, 'p', this.value)" rows="2">${it.p}</textarea></td>
                    <td class="p-3 border border-slate-300"><textarea class="edit-input" oninput="updProg(${i}, 'k', this.value)" rows="5">${it.k}</textarea></td>
                    <td class="p-3 border border-slate-300"><textarea class="edit-input italic" oninput="updProg(${i}, 'i', this.value)" rows="5">${it.i}</textarea></td>
                `;
                tbody.appendChild(tr);
            });
        }
        function updProg(i, k, v) { progData[i][k] = v; saveData('prog_pilar', JSON.stringify(progData)); autoResizeTextareas(); }

        function autoResizeTextareas() {
            document.querySelectorAll('textarea.edit-input, textarea.form-control').forEach(el => {
                el.style.height = 'auto';
                el.style.height = (el.scrollHeight) + 'px';
            });
        }

        // Student Data Logic
        let studentData = JSON.parse(loadData('students_v2')) || [];
        function renderStudents() {
            const tbody = document.getElementById('studentTable');
            if(!tbody) return;
            tbody.innerHTML = '';
            studentData.forEach((st, i) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="border p-3 text-center font-bold text-slate-300">${i+1}</td>
                    <td class="border p-3"><input type="text" value="${st.nama || ''}" class="w-full bg-transparent font-bold outline-none" oninput="updSt(${i}, 'nama', this.value)"></td>
                    <td class="border p-3"><input type="text" value="${st.nis || ''}" class="w-full bg-transparent font-mono text-xs outline-none" oninput="updSt(${i}, 'nis', this.value)"></td>
                    <td class="border p-3"><input type="text" value="${st.nisn || ''}" class="w-full bg-transparent font-mono text-xs outline-none" oninput="updSt(${i}, 'nisn', this.value)"></td>
                    <td class="border p-3">
                        <select class="w-full bg-transparent outline-none cursor-pointer text-xs" onchange="updSt(${i}, 'jk', this.value)">
                            <option value="" ${!st.jk ? 'selected' : ''}>-</option>
                            <option value="L" ${st.jk === 'L' ? 'selected' : ''}>L</option>
                            <option value="P" ${st.jk === 'P' ? 'selected' : ''}>P</option>
                        </select>
                    </td>
                    <td class="border p-3"><input type="text" value="${st.kelas || ''}" class="w-full bg-transparent text-center outline-none" oninput="updSt(${i}, 'kelas', this.value)"></td>
                    <td class="border p-3"><input type="text" value="${st.tahunMasuk || ''}" class="w-full bg-transparent text-center outline-none" oninput="updSt(${i}, 'tahunMasuk', this.value)"></td>
                    <td class="border p-3 text-center no-print bg-slate-50"><button onclick="delSt(${i})" class="text-slate-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
            refreshIcons();
        }
        function updSt(i, k, v) { studentData[i][k] = v; saveData('students_v2', JSON.stringify(studentData)); }
        function addStudentRow() { studentData.push({ nama: "", nis: "", nisn: "", jk: "", kelas: "", tahunMasuk: "" }); renderStudents(); saveData('students_v2', JSON.stringify(studentData)); }
        function delSt(i) { if(confirm("Hapus murid ini?")) { studentData.splice(i, 1); renderStudents(); saveData('students_v2', JSON.stringify(studentData)); } }

        // PROFILE MURID SPECIFIC LOGIC
        let profileDetails = JSON.parse(loadData('profile_details')) || {};

        function updateStudentDropdown() {
            const select = document.getElementById('profilNamaSelect');
            const currentVal = select.value;
            select.innerHTML = '<option value="">-- Pilih Murid --</option>';
            studentData.forEach((st, i) => {
                if(st.nama) {
                    const opt = document.createElement('option');
                    opt.value = i;
                    opt.textContent = st.nama;
                    select.appendChild(opt);
                }
            });
            select.value = currentVal;
        }

        function loadStudentProfile(index) {
            if(index === "") { resetProfileForm(); return; }
            const st = studentData[index];
            const guruNama = loadData('guru_name') || '-';
            
            document.getElementById('profilNis').value = (st.nis || '-') + ' / ' + (st.nisn || '-');
            document.getElementById('profilKelas').value = st.kelas || '-';
            document.getElementById('profilGuruWali').value = guruNama;
            document.getElementById('profilTahunMasuk').value = st.tahunMasuk || '-';

            // Load extra details
            const details = profileDetails[index] || {};
            const fields = ['alamat', 'telp', 'ortu', 'pekerjaan', 'rapor', 'mapel_suka', 'mapel_sulit', 'hobi', 'ekskul', 'prestasi', 'target', 'dukungan', 'catatan'];
            fields.forEach(f => {
                document.getElementById('prof_' + f).value = details[f] || '';
            });
            autoResizeTextareas();
        }

        function saveProfileData(field, val) {
            const index = document.getElementById('profilNamaSelect').value;
            if(index === "") return;
            if(!profileDetails[index]) profileDetails[index] = {};
            profileDetails[index][field] = val;
            saveData('profile_details', JSON.stringify(profileDetails));
        }

        function resetProfileForm() {
            ['profilNis', 'profilKelas', 'profilGuruWali', 'profilTahunMasuk'].forEach(id => document.getElementById(id).value = '');
            const fields = ['alamat', 'telp', 'ortu', 'pekerjaan', 'rapor', 'mapel_suka', 'mapel_sulit', 'hobi', 'ekskul', 'prestasi', 'target', 'dukungan', 'catatan'];
            fields.forEach(f => document.getElementById('prof_' + f).value = '');
        }

        async function syncToCloud() { 
            alert("Fitur simpan cloud memerlukan API URL yang valid di menu Settings.");
        }
        
        function downloadBackup() { 
            const data = {
                guru: {
                    nama: loadData('guru_name'),
                    nip: loadData('guru_nip'),
                    kelas: loadData('guru_kelas'),
                    tahun: loadData('guru_tahun_pelajaran_select') === 'Lainnya' ? loadData('guru_tahun_pelajaran_manual') : loadData('guru_tahun_pelajaran_select')
                },
                program: progData,
                murid: studentData,
                profilDetail: profileDetails
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `backup_guru_wali_${new Date().getTime()}.json`;
            a.click();
        }

        window.addEventListener('DOMContentLoaded', () => {
            document.getElementById('namaGuru').value = loadData('guru_name') || '';
            document.getElementById('nipGuru').value = loadData('guru_nip') || '';
            document.getElementById('kelasGuru').value = loadData('guru_kelas') || '';
            
            const savedTahun = loadData('guru_tahun_pelajaran_select') || '';
            document.getElementById('tahunPelajaranSelect').value = savedTahun;
            handleTahunPelajaran(savedTahun);
            document.getElementById('tahunPelajaranManual').value = loadData('guru_tahun_pelajaran_manual') || '';

            renderProg();
            renderStudents();
            refreshIcons();
        });
    </script>
</body>
</html>
